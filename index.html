<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LineUp - AI Haircut Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior-y: contain; /* Prevents pull-to-refresh on mobile */
        }
        /* Custom scrollbar for a more modern look */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #4a4a4a; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #6a6a6a; }
        .gradient-text {
            background: linear-gradient(90deg, #38bdf8, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #38bdf8;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Style for the active tab */
        .tab-active, .tab-button:hover {
            color: #38bdf8;
        }
    </style>
</head>
<body class="bg-black text-gray-200 min-h-screen">
    <div id="app" class="container mx-auto max-w-4xl pb-24">

        <!-- Header -->
        <header class="text-center p-4 md:p-8">
            <h1 class="text-4xl md:text-5xl font-bold gradient-text">LineUp</h1>
            <p class="text-gray-400 mt-2">AI Hairstylist & Social Community</p>
        </header>

        <main id="main-content">
            <!-- AI Analysis Tab Content -->
            <div id="ai-tab-content" class="tab-content px-4">
                <!-- Upload Section -->
                <section id="upload-section" class="bg-gray-900/50 border border-gray-700 rounded-2xl p-6 md:p-8 text-center transition-all duration-300">
                    <div id="image-upload-area" class="border-2 border-dashed border-gray-600 rounded-xl p-8 md:p-12 cursor-pointer hover:border-sky-400 hover:bg-gray-800/50 transition-all duration-300">
                        <input type="file" id="file-input" class="hidden" accept="image/*">
                        <div class="flex flex-col items-center">
                            <svg class="w-12 h-12 text-gray-500 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5" /></svg>
                            <p class="font-semibold text-lg">Upload a photo to get started</p>
                            <p class="text-sm text-gray-400 mt-1">For best results, use a clear, front-facing photo.</p>
                        </div>
                    </div>
                    <div id="image-preview-container" class="hidden mt-6">
                        <img id="image-preview" src="" alt="Your uploaded photo" class="max-w-xs mx-auto rounded-xl shadow-lg"/>
                        <button id="analyze-button" class="mt-6 bg-sky-500 text-white font-bold py-3 px-8 rounded-full hover:bg-sky-600 transition-all duration-300 transform hover:scale-105">Analyze My Look</button>
                    </div>
                </section>
                <!-- Status Section -->
                <section id="status-section" class="text-center my-8 hidden"><div id="loader" class="mx-auto loader hidden"></div><p id="status-message" class="mt-4 text-lg"></p><div id="error-container" class="mt-4 bg-red-900/50 border border-red-700 text-red-300 px-4 py-3 rounded-xl hidden"><p id="error-message"></p><button id="try-again-button" class="mt-4 bg-gray-700 text-white font-semibold py-2 px-6 rounded-lg hover:bg-gray-600 transition-colors">Try Again</button></div></section>
                <!-- Results Section -->
                <section id="results-section" class="hidden mt-12">
                    <div class="bg-gray-900/50 border border-gray-700 rounded-2xl p-6 mb-8"><h2 class="text-2xl font-bold mb-4">Your Analysis</h2><div id="analysis-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center"></div></div>
                    <div><h2 class="text-3xl font-bold text-center mb-8">Recommended Haircuts</h2><div id="recommendations-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div></div>
                    <div class="text-center mt-8 border-t border-gray-700 pt-8"><p class="text-lg mb-4">Ready for the perfect cut?</p><button id="find-barber-button" class="bg-green-500 text-white font-bold py-3 px-8 rounded-full hover:bg-green-600 transition-all">Find a Barber for These Styles</button></div>
                    <div class="text-center mt-12"><button id="start-over-button" class="bg-gray-700 text-white font-semibold py-3 px-8 rounded-full hover:bg-gray-600">Start Over</button></div>
                </section>
            </div>

            <!-- Barbers Tab Content -->
            <div id="barbers-tab-content" class="tab-content hidden px-4">
                 <h2 class="text-3xl font-bold text-center mb-6">Top Barbers in Atlanta</h2>
                 <p id="barber-intro" class="text-center text-gray-400 mb-8">Here are some top-rated barbers who can nail your new look.</p>
                 <div id="barber-list-container" class="space-y-4"></div>
            </div>

            <!-- Social Tab Content -->
            <div id="social-tab-content" class="tab-content hidden px-4">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">Community Looks</h2>
                    <button id="add-post-button" class="bg-sky-500 rounded-full p-3 hover:bg-sky-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>
                    </button>
                </div>
                <div id="social-feed-container" class="space-y-8">
                     <!-- Social posts will be injected here -->
                     <p id="no-posts-message" class="text-center text-gray-500 py-10">No posts yet. Be the first to share your look!</p>
                </div>
            </div>
        </main>
        
        <!-- Tab Navigation Bar -->
        <nav class="fixed bottom-0 left-0 right-0 bg-black/80 backdrop-blur-sm border-t border-gray-700 max-w-4xl mx-auto">
            <div class="flex justify-around h-16">
                <button class="tab-button flex flex-col items-center justify-center w-full text-gray-400 transition-colors tab-active" data-tab="ai">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
                    <span class="text-xs mt-1">AI Stylist</span>
                </button>
                <button class="tab-button flex flex-col items-center justify-center w-full text-gray-400 transition-colors" data-tab="barbers">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5.636 18.364a9 9 0 010-12.728m12.728 0a9 9 0 010 12.728m-9.9-1.414v.001M9 12h.01M15 12h.01M12 9v.01M18.364 5.636a9 9 0 010 12.728m-12.728 0a9 9 0 010-12.728" /></svg>
                    <span class="text-xs mt-1">Barbers</span>
                </button>
                <button class="tab-button flex flex-col items-center justify-center w-full text-gray-400 transition-colors" data-tab="social">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                    <span class="text-xs mt-1">Social</span>
                </button>
            </div>
        </nav>
        
        <!-- Modal for Adding a New Post -->
        <div id="add-post-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50 hidden">
            <div class="bg-gray-900 rounded-2xl p-6 w-full max-w-md relative">
                <button id="close-modal-button" class="absolute top-3 right-3 text-gray-400 hover:text-white">&times;</button>
                <h3 class="text-2xl font-bold mb-4">Share Your Look</h3>
                <div id="post-upload-area" class="border-2 border-dashed border-gray-600 rounded-xl p-8 text-center cursor-pointer hover:border-sky-400">
                    <p>Click to upload photo</p>
                </div>
                <img id="post-image-preview" class="hidden w-full rounded-lg my-4 max-h-60 object-cover"/>
                <input type="file" id="post-file-input" class="hidden" accept="image/*">
                <textarea id="post-caption-input" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2 mt-4 text-white" placeholder="Add a caption..."></textarea>
                <button id="submit-post-button" class="w-full bg-sky-500 text-white font-bold py-3 mt-4 rounded-lg hover:bg-sky-600 disabled:opacity-50">Post</button>
            </div>
        </div>

        <!-- Booking Modal -->
        <div id="booking-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50 hidden">
            <div class="bg-gray-900 rounded-2xl p-6 w-full max-w-sm text-center">
                 <h3 id="booking-title" class="text-2xl font-bold mb-2">Booking Confirmation</h3>
                 <p id="booking-message" class="text-gray-300 mb-6">Your appointment request has been sent!</p>
                 <button id="close-booking-modal" class="bg-sky-500 text-white font-bold py-2 px-6 rounded-lg">Done</button>
            </div>
        </div>
        
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, getDocs, onSnapshot, updateDoc, increment, arrayUnion, arrayRemove, serverTimestamp, setLogLevel, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DOM Elements ---
        const fileInput = document.getElementById('file-input'), imageUploadArea = document.getElementById('image-upload-area'), imagePreviewContainer = document.getElementById('image-preview-container'), imagePreview = document.getElementById('image-preview'), analyzeButton = document.getElementById('analyze-button'), uploadSection = document.getElementById('upload-section'), statusSection = document.getElementById('status-section'), loader = document.getElementById('loader'), statusMessage = document.getElementById('status-message'), errorContainer = document.getElementById('error-container'), errorMessage = document.getElementById('error-message'), tryAgainButton = document.getElementById('try-again-button'), resultsSection = document.getElementById('results-section'), analysisGrid = document.getElementById('analysis-grid'), recommendationsContainer = document.getElementById('recommendations-container'), startOverButton = document.getElementById('start-over-button'), findBarberButton = document.getElementById('find-barber-button'), barberListContainer = document.getElementById('barber-list-container'), socialFeedContainer = document.getElementById('social-feed-container'), addPostButton = document.getElementById('add-post-button'), addPostModal = document.getElementById('add-post-modal'), closeModalButton = document.getElementById('close-modal-button'), postUploadArea = document.getElementById('post-upload-area'), postFileInput = document.getElementById('post-file-input'), postImagePreview = document.getElementById('post-image-preview'), postCaptionInput = document.getElementById('post-caption-input'), submitPostButton = document.getElementById('submit-post-button'), bookingModal = document.getElementById('booking-modal'), closeBookingModal = document.getElementById('close-booking-modal'), barberIntro = document.getElementById('barber-intro');
        
        // --- State Variables ---
        let base64ImageData = null, postBase64ImageData = null, lastRecommendedStyles = [], currentUser = null;

        // --- Mock Data for Atlanta Barbers ---
        const atlantaBarbers = [
            { id: 1, name: 'Cuts by Clay', specialties: ['Fade', 'Taper', 'Modern Mullet'], rating: 4.9, avgCost: 45, location: 'Midtown' },
            { id: 2, name: 'The Buckhead Barber', specialties: ['Classic Pompadour', 'Buzz Cut', 'Crew Cut'], rating: 4.8, avgCost: 55, location: 'Buckhead' },
            { id: 3, name: 'Virginia-Highland Shears', specialties: ['Shag', 'Bob', 'Long Layers'], rating: 4.9, avgCost: 75, location: 'Virginia-Highland' },
            { id: 4, name: 'East Atlanta Edge', specialties: ['Fade', 'Undercut', 'Curly Top'], rating: 4.7, avgCost: 40, location: 'East Atlanta' },
            { id: 5, name: 'Ponce City Fades', specialties: ['Taper', 'Crew Cut', 'Quiff'], rating: 4.8, avgCost: 50, location: 'Old Fourth Ward' },
            { id: 6, name: 'Westside Style House', specialties: ['Long Layers', 'Shag', 'Wavy Bob'], rating: 4.9, avgCost: 80, location: 'West Midtown' }
        ];

        // --- Firebase Setup ---
        // IMPORTANT: PASTE YOUR FIREBASE CONFIGURATION OBJECT HERE
        // 1. Go to your Firebase project console.
        // 2. Click the gear icon > Project settings.
        // 3. In the "Your apps" card, select the web app.
        // 4. Select "Config" and copy the firebaseConfig object.
        // 5. Paste it below, replacing the empty {}.
        const firebaseConfig = {
            // apiKey: "...",
            // authDomain: "...",
            // projectId: "...",
            // storageBucket: "...",
            // messagingSenderId: "...",
            // appId: "..."
        };

        let db, auth;
        // Initialize Firebase
        if (firebaseConfig.apiKey) {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug');

                // --- Authentication ---
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUser = user;
                        console.log("User is signed in:", currentUser.uid);
                        listenForSocialPosts();
                    } else {
                        signInAnonymously(auth).catch((error) => console.error("Anonymous sign-in failed:", error));
                    }
                });

            } catch (e) {
                console.error("Firebase initialization failed:", e);
                alert("Could not connect to the database. Social features are disabled.");
            }
        } else {
            console.warn("Firebase config is missing. Social and database features will be disabled.");
            // Disable social tab if Firebase isn't configured
            document.querySelector('[data-tab="social"]').style.display = 'none';
        }
        
        
        // --- Tab Navigation ---
        const tabs = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const targetTab = tab.dataset.tab;

                tabs.forEach(t => t.classList.remove('tab-active'));
                tab.classList.add('tab-active');
                
                tabContents.forEach(content => {
                    content.classList.add('hidden');
                    if (content.id === `${targetTab}-tab-content`) {
                        content.classList.remove('hidden');
                    }
                });
            });
        });

        function switchToTab(tabName) {
            document.querySelector(`.tab-button[data-tab="${tabName}"]`).click();
        }

        // --- Event Listeners ---
        imageUploadArea.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => handleFileSelect(e, 'analysis'));
        analyzeButton.addEventListener('click', startAnalysis);
        tryAgainButton.addEventListener('click', resetUI);
        startOverButton.addEventListener('click', resetUI);
        findBarberButton.addEventListener('click', showBarbersForRecommendations);
        
        // Social Post Modal Listeners
        addPostButton.addEventListener('click', () => {
             if (!firebaseConfig.apiKey) {
                alert("Please configure Firebase to enable social features.");
                return;
            }
            addPostModal.classList.remove('hidden');
        });
        closeModalButton.addEventListener('click', resetPostModal);
        postUploadArea.addEventListener('click', () => postFileInput.click());
        postFileInput.addEventListener('change', (e) => handleFileSelect(e, 'post'));
        submitPostButton.addEventListener('click', handleSubmitPost);

        // Booking Modal Listeners
        closeBookingModal.addEventListener('click', () => bookingModal.classList.add('hidden'));

        // --- AI Analysis Functions ---
        function handleFileSelect(event, type) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                if (type === 'analysis') {
                    base64ImageData = e.target.result.split(',')[1];
                    imagePreview.src = e.target.result;
                    imageUploadArea.classList.add('hidden');
                    imagePreviewContainer.classList.remove('hidden');
                } else if (type === 'post') {
                    postBase64ImageData = e.target.result.split(',')[1];
                    postImagePreview.src = e.target.result;
                    postUploadArea.classList.add('hidden');
                    postImagePreview.classList.remove('hidden');
                }
            };
            reader.readAsDataURL(file);
        }

        function resetUI() {
            uploadSection.classList.remove('hidden'); statusSection.classList.add('hidden'); resultsSection.classList.add('hidden'); errorContainer.classList.add('hidden'); loader.classList.add('hidden'); imageUploadArea.classList.remove('hidden'); imagePreviewContainer.classList.add('hidden'); imagePreview.src = ''; fileInput.value = ''; base64ImageData = null;
        }

        async function startAnalysis() {
            if (!base64ImageData) { showError("Please upload an image first."); return; }
            uploadSection.classList.add('hidden'); resultsSection.classList.add('hidden'); statusSection.classList.remove('hidden'); loader.classList.remove('hidden'); errorContainer.classList.add('hidden'); statusMessage.textContent = "Checking your photo...";
            try {
                const isFace = await validateImageIsFace(base64ImageData);
                if (!isFace) throw new Error("This doesn't look like a photo of a person's face. Please upload a different image.");
                statusMessage.textContent = "Analyzing your features... This may take a moment.";
                const analysisResult = await getHaircutAnalysis(base64ImageData);
                displayResults(analysisResult);
            } catch (error) {
                console.error("Analysis failed:", error);
                showError(error.message || "An unknown error occurred during analysis.");
            } finally {
                loader.classList.add('hidden'); statusMessage.textContent = '';
            }
        }
        
        function showError(message) {
            loader.classList.add('hidden'); statusMessage.textContent = ''; errorContainer.classList.remove('hidden'); errorMessage.textContent = message;
        }

        function displayResults(data) {
            statusSection.classList.add('hidden'); resultsSection.classList.remove('hidden');
            analysisGrid.innerHTML = '';
            const analysisData = [{ label: 'Face Shape', value: data.analysis.faceShape }, { label: 'Hair Texture', value: data.analysis.hairTexture }, { label: 'Est. Age', value: data.analysis.estimatedAge }, { label: 'Gender', value: data.analysis.estimatedGender }];
            analysisData.forEach(item => {
                const div = document.createElement('div');
                div.className = 'bg-gray-800 p-4 rounded-lg';
                div.innerHTML = `<p class="text-sm text-gray-400">${item.label}</p><p class="font-bold text-lg text-white">${item.value}</p>`;
                analysisGrid.appendChild(div);
            });
            recommendationsContainer.innerHTML = '';
            lastRecommendedStyles = data.recommendations.map(rec => rec.styleName);
            data.recommendations.forEach(rec => {
                const card = document.createElement('div');
                card.className = 'bg-gray-900/50 border border-gray-700 rounded-2xl overflow-hidden flex flex-col';
                const placeholderImageUrl = `https://placehold.co/600x400/000000/FFFFFF?text=${encodeURIComponent(rec.styleName)}`;
                card.innerHTML = `<img src="${placeholderImageUrl}" alt="${rec.styleName}" class="w-full h-48 object-cover"><div class="p-5 flex flex-col flex-grow"><h3 class="text-xl font-bold text-white mb-2">${rec.styleName}</h3><p class="text-gray-300 text-sm mb-4 flex-grow">${rec.description}</p><p class="text-xs text-gray-400"><strong class="text-sky-400">Why it works:</strong> ${rec.reason}</p></div>`;
                recommendationsContainer.appendChild(card);
            });
        }

        // --- Barber Functions ---
        function showBarbersForRecommendations() {
            barberIntro.textContent = "Here are some top-rated barbers who specialize in your recommended styles."
            const recommendedBarbers = atlantaBarbers.filter(barber => 
                barber.specialties.some(specialty => lastRecommendedStyles.includes(specialty))
            );
            const barbersToDisplay = recommendedBarbers.length > 0 ? recommendedBarbers : atlantaBarbers; // Show all if no direct match
            renderBarberList(barbersToDisplay);
            switchToTab('barbers');
        }

        function renderBarberList(barbers) {
            barberListContainer.innerHTML = '';
            if (barbers.length === 0) {
                barberListContainer.innerHTML = `<p class="text-center text-gray-500">No barbers found matching the criteria.</p>`;
                return;
            }
            barbers.forEach(barber => {
                const card = document.createElement('div');
                card.className = 'bg-gray-900/50 border border-gray-700 rounded-2xl p-5 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4';
                card.innerHTML = `
                    <div>
                        <h4 class="text-xl font-bold">${barber.name}</h4>
                        <p class="text-sm text-gray-400">${barber.location}</p>
                        <div class="flex items-center gap-4 mt-2">
                            <span class="text-yellow-400 flex items-center gap-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
                                ${barber.rating}
                            </span>
                            <span class="text-green-400 font-semibold">~$${barber.avgCost}</span>
                        </div>
                    </div>
                    <button class="book-button w-full sm:w-auto bg-sky-500 text-white font-semibold py-2 px-6 rounded-lg hover:bg-sky-600 transition-colors" data-barber-name="${barber.name}">Book Now</button>
                `;
                barberListContainer.appendChild(card);
            });
            document.querySelectorAll('.book-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const barberName = e.target.dataset.barberName;
                    document.getElementById('booking-title').textContent = `Booking with ${barberName}`;
                    bookingModal.classList.remove('hidden');
                });
            });
        }
        
        // --- Social Feed (Firestore) Functions ---
        function resetPostModal() {
            addPostModal.classList.add('hidden');
            postImagePreview.classList.add('hidden');
            postUploadArea.classList.remove('hidden');
            postFileInput.value = '';
            postCaptionInput.value = '';
            postBase64ImageData = null;
        }

        async function handleSubmitPost() {
            if (!postBase64ImageData || !postCaptionInput.value.trim()) {
                alert("Please add a photo and a caption."); return;
            }
            if (!db || !currentUser) {
                alert("Could not connect to the server. Please try again later."); return;
            }
            submitPostButton.disabled = true;
            submitPostButton.textContent = "Posting...";
            
            try {
                const appId = firebaseConfig.appId || 'default-lineup-app';
                const socialPostsCollection = collection(db, 'artifacts', appId, 'public/data/social_posts');
                await addDoc(socialPostsCollection, {
                    userId: currentUser.uid,
                    imageUrl: postBase64ImageData, // For MVP, storing base64. For production, use Firebase Storage and store URL.
                    caption: postCaptionInput.value.trim(),
                    likes: 0,
                    likedBy: [],
                    timestamp: serverTimestamp()
                });
                resetPostModal();
            } catch (error) {
                console.error("Error creating post:", error);
                alert("Failed to create post. Please try again.");
            } finally {
                submitPostButton.disabled = false;
                submitPostButton.textContent = "Post";
            }
        }
        
        function listenForSocialPosts() {
            if (!db) return;
            const appId = firebaseConfig.appId || 'default-lineup-app';
            const socialPostsCollection = collection(db, 'artifacts', appId, 'public/data/social_posts');
            const q = query(socialPostsCollection); // Can add orderBy('timestamp', 'desc') later if needed, but requires index.
            
            onSnapshot(q, (snapshot) => {
                const posts = [];
                snapshot.forEach((doc) => posts.push({ id: doc.id, ...doc.data() }));
                // Sort in memory to avoid needing a Firestore index for this MVP
                posts.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                renderSocialFeed(posts);
            }, (error) => {
                console.error("Error listening to social posts:", error);
            });
        }
        
        function renderSocialFeed(posts) {
            socialFeedContainer.innerHTML = '';
            if (posts.length === 0) {
                socialFeedContainer.innerHTML = `<p id="no-posts-message" class="text-center text-gray-500 py-10">No posts yet. Be the first to share your look!</p>`;
                return;
            }
            posts.forEach(post => {
                const postCard = document.createElement('div');
                postCard.className = 'bg-gray-900/50 border border-gray-700 rounded-2xl overflow-hidden';
                const isLiked = currentUser && post.likedBy.includes(currentUser.uid);
                
                postCard.innerHTML = `
                    <img src="data:image/jpeg;base64,${post.imageUrl}" alt="User haircut post" class="w-full h-auto max-h-[70vh] object-cover">
                    <div class="p-4">
                        <p class="text-white mb-3">${post.caption}</p>
                        <div class="flex items-center gap-2">
                            <button class="like-button" data-post-id="${post.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 transition-colors ${isLiked ? 'text-red-500 fill-current' : 'text-gray-400'}" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 016.364 0L12 7.5l1.318-1.182a4.5 4.5 0 116.364 6.364L12 20.25l-7.682-7.682a4.5 4.5 0 010-6.364z" />
                                </svg>
                            </button>
                            <span class="text-gray-300 font-semibold">${post.likes}</span>
                        </div>
                    </div>
                `;
                socialFeedContainer.appendChild(postCard);
            });
            
            // Add event listeners for like buttons
            document.querySelectorAll('.like-button').forEach(button => {
                button.addEventListener('click', () => handleLike(button.dataset.postId));
            });
        }
        
        async function handleLike(postId) {
            if (!db || !currentUser) return;
            const appId = firebaseConfig.appId || 'default-lineup-app';
            const postRef = doc(db, 'artifacts', appId, 'public/data/social_posts', postId);
            // This is a simplified like toggle. A transaction would be safer in production.
            try {
                // To avoid fetching the doc first, we check a local copy of posts or just send updates.
                // For this MVP, we will send an update and let onSnapshot handle the UI.
                // A better approach is to check if user is in likedBy array before updating.
                await updateDoc(postRef, {
                    likes: increment(1), // simplified, doesn't handle unlike
                    likedBy: arrayUnion(currentUser.uid)
                });
            } catch (error) {
                console.error("Error liking post:", error);
            }
        }
        
        // --- Gemini API Call Functions ---
        
        // The URL now points to our own backend service, which will be handled by Render's rewrite rule.
        const API_URL = `/analyze`; 

        async function makeApiCall(payload, retryCount = 0) { // Retries are less necessary for an internal service
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    // The Python backend expects the original payload structure
                    body: JSON.stringify({ payload }), 
                });

                const result = await response.json();
                
                if (!response.ok) {
                    // Use the error message from our own backend
                    throw new Error(result.error || `Server responded with status: ${response.status}`);
                }
                
                // Check for the expected Gemini-like structure our Python server creates
                if (result.candidates?.[0]?.content?.parts?.[0]) {
                    return result;
                }
                
                throw new Error("Invalid response structure from backend.");

            } catch (error) {
                 // No retry logic needed here for the self-hosted model
                console.error("API call failed:", error);
                throw error;
            }
        }
        async function validateImageIsFace(imageData) {
            // With the new backend, validation and analysis happen in one step.
            // We create the payload here and the backend will validate it.
            // If it's not a face, the backend will return an error which we'll catch in startAnalysis.
            return true; // We now assume it's a face and let the backend verify.
        }
        async function getHaircutAnalysis(imageData) {
            // This function now just prepares the payload and sends it. The Python backend does all the work.
            const userQuery = "Analyze the person in this photo."; // The prompt text is now less important.
            const payload = { 
                contents: [{ 
                    parts: [
                        { text: userQuery }, 
                        { inlineData: { mimeType: "image/jpeg", data: imageData } }
                    ] 
                }] 
            };
            const result = await makeApiCall(payload);
            // The Python server returns the final JSON inside the 'text' property of the first part.
            return JSON.parse(result.candidates[0].content.parts[0].text);
        }
        
        // --- Initial Load ---
        renderBarberList(atlantaBarbers); // Pre-populate the barbers tab
    </script>
</body>
</html>



